generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Request {
  id           String     @id @default(uuid())
  status       Status     @default(Pending)
  description  String
  resourcesId  String     @unique
  repositoryId String     @unique
  ownerId      String
  createdAt    DateTime   @default(now())
  displayCode  String     @unique
  updatedAt    DateTime   @updatedAt
  feedback     String?
  owner        User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  resources    Resources  @relation(fields: [resourcesId], references: [id], onDelete: Cascade)
}

model Repository {
  id                     String                   @id @default(cuid())
  name                   String                   @unique
  description            String?
  resourcesId            String                   @unique
  status                 RepositoryStatus         @default(Pending)
  resources              Resources                @relation(fields: [resourcesId], references: [id], onDelete: Cascade)
  RepositoryCollaborator RepositoryCollaborator[]
  request                Request?
  UserRepository         ownedRepository[]
  collaborators          User[]                   @relation("RepositoryCollaborators")
}

model Resources {
  id               String         @id @default(uuid())
  name             String
  cloudProvider    String
  region           String
  resourceConfigId String         @unique
  repository       Repository?
  request          Request?
  resourceConfig   ResourceConfig @relation(fields: [resourceConfigId], references: [id], onDelete: Cascade)
}

model ResourceConfig {
  id        String             @id @default(uuid())
  dbs       DatabaseInstance[]
  resources Resources?
  sts       StorageInstance[]
  vms       VMInstance[]
}

model VMInstance {
  id               String         @id @default(uuid())
  name             String
  os               String
  resourceConfigId String
  sizeId           String
  resourceConfig   ResourceConfig @relation(fields: [resourceConfigId], references: [id], onDelete: Cascade)
  size             AzureVMSize    @relation(fields: [sizeId], references: [id], onDelete: Cascade)
}

model DatabaseInstance {
  id               String         @id @default(uuid())
  storageGB        Int            @default(32768)
  resourceConfigId String
  name             String         @default("database-instance")
  password         String         @default("P@ssw0rd!")
  skuName          String         @default("B_Standard_B1ms")
  username         String         @default("orchestronic_user")
  engine           Engine         @default(PostgreSQL)
  resourceConfig   ResourceConfig @relation(fields: [resourceConfigId], references: [id], onDelete: Cascade)
}

model StorageInstance {
  id               String         @id @default(uuid())
  resourceConfigId String
  accessTier       String         @default("Hot")
  kind             String         @default("StorageV2")
  name             String         @default("storage-instance")
  sku              String         @default("Standard_LRS")
  resourceConfig   ResourceConfig @relation(fields: [resourceConfigId], references: [id], onDelete: Cascade)
}

model User {
  id                     String                   @id @default(uuid())
  name                   String
  email                  String                   @unique
  role                   Role
  CloudResourceSecret    CloudResourceSecret[]
  RefreshToken           RefreshToken[]
  RepositoryCollaborator RepositoryCollaborator[]
  request                Request[]
  UserRepository         ownedRepository[]
  collaboratedRepos      Repository[]             @relation("RepositoryCollaborators")
}

model ownedRepository {
  userId       String
  repositoryId String
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, repositoryId])
}

model RepositoryCollaborator {
  userId       String
  repositoryId String
  assignedAt   DateTime   @default(now())
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, repositoryId])
  @@map("RepositoryCollaborators")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CloudResourceSecret {
  id             String        @id @default(uuid())
  clientId       String        @unique
  clientSecret   String
  subscriptionId String        @unique
  tenantId       String?
  cloudProvider  CloudProvider
  userId         String
  User           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AzureVMSize {
  id                   String       @id @default(uuid())
  name                 String       @unique
  numberOfCores        Int
  maxDataDiskCount     Int
  memoryInMB           Int
  osDiskSizeInMB       Int
  resourceDiskSizeInMB Int
  VMInstance           VMInstance[]
}

model PolicyVM {
  id            String        @id @default(uuid())
  name          String
  memoryInMB    Int
  numberOfCores Int
  cloudProvider CloudProvider @unique
}

model PolicyDatabase {
  id            String        @id @default(uuid())
  maxStorage    Int
  cloudProvider CloudProvider @unique
}

model PolicyStorage {
  id            String        @id @default(uuid())
  maxStorage    Int
  cloudProvider CloudProvider @unique
}

enum RepositoryStatus {
  Created
  Pending
}

enum CloudProvider {
  AWS
  AZURE
}

enum Status {
  Pending
  Approved
  Rejected
}

enum Role {
  Admin
  IT
  Developer
}

enum Engine {
  MySQL
  PostgreSQL
}
