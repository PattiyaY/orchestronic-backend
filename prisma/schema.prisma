generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Request {
  id           String     @id @default(uuid())
  status       Status     @default(Pending)
  description  String
  resourcesId  String     @unique
  repositoryId String     @unique
  ownerId      String
  createdAt    DateTime   @default(now())
  displayCode  String     @unique
  updatedAt    DateTime   @updatedAt
  feedback     String?
  owner        User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  resources    Resources  @relation(fields: [resourcesId], references: [id], onDelete: Cascade)
}

model Repository {
  id                     String                   @id @default(cuid())
  name                   String                   @unique
  description            String?
  resourcesId            String                   @unique
  status                 RepositoryStatus         @default(Pending)
  resources              Resources                @relation(fields: [resourcesId], references: [id], onDelete: Cascade)
  RepositoryCollaborator RepositoryCollaborator[]
  request                Request?
  UserRepository         ownedRepository[]
  collaborators          User[]                   @relation("RepositoryCollaborators")
}

model Resources {
  id               String         @id @default(uuid())
  name             String
  cloudProvider    CloudProvider
  region           String
  resourceConfigId String         @unique
  repository       Repository?
  request          Request?
  resourceConfig   ResourceConfig @relation(fields: [resourceConfigId], references: [id], onDelete: Cascade)
}

model ResourceConfig {
  id              String                  @id @default(uuid())
  AzureDatabase   AzureDatabaseInstance[]
  resources       Resources?
  AzureStorage    AzureStorageInstance[]
  AzureVMInstance AzureVMInstance[]
  AwsVMInstance   AwsVMInstance[]
  AwsStorage      AwsStorageInstance[]
  AwsDatabase     AwsDatabaseInstance[]
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
}

model AzureDatabaseInstance {
  id               String         @id @default(uuid())
  storageGB        Int            @default(32768)
  resourceConfigId String
  name             String         @default("database-instance")
  password         String         @default("P@ssw0rd!")
  skuName          String         @default("B_Standard_B1ms")
  username         String         @default("orchestronic_user")
  engine           Engine         @default(PostgreSQL)
  terraformState   Json?
  resourceConfig   ResourceConfig @relation(fields: [resourceConfigId], references: [id], onDelete: Cascade)
}

model AzureStorageInstance {
  id               String         @id @default(uuid())
  resourceConfigId String
  accessTier       String         @default("Hot")
  kind             String         @default("StorageV2")
  name             String         @default("storage-instance")
  sku              String         @default("Standard_LRS")
  terraformState   Json?
  resourceConfig   ResourceConfig @relation(fields: [resourceConfigId], references: [id], onDelete: Cascade)
}

model User {
  id                     String                   @id @default(uuid())
  name                   String
  email                  String                   @unique
  role                   Role
  CloudResourceSecret    CloudResourceSecret[]
  RepositoryCollaborator RepositoryCollaborator[]
  request                Request[]
  UserRepository         ownedRepository[]
  collaboratedRepos      Repository[]             @relation("RepositoryCollaborators")
}

model AzureVMInstance {
  id               String         @id @default(uuid())
  name             String
  os               String
  sizeId           String
  terraformState   Json?
  size             AzureVMSize    @relation(fields: [sizeId], references: [id], onDelete: Cascade)
  resourceConfigId String
  resourceConfig   ResourceConfig @relation(fields: [resourceConfigId], references: [id], onDelete: Cascade)
}

model AwsVMInstance {
  id                String          @id @default(uuid())
  instanceName      String
  os                String
  keyName           String
  sgName            String
  resourceConfigId  String
  terraformState    Json?
  ResourceConfig    ResourceConfig  @relation(fields: [resourceConfigId], references: [id])
  awsInstanceTypeId String
  AwsInstanceType   AwsInstanceType @relation(fields: [awsInstanceTypeId], references: [id])
}

model AwsDatabaseInstance {
  id                 String          @id @default(uuid())
  dbName             String
  dbUsername         String
  dbPassword         String
  awsDatabaseTypeId  String
  dbInstanceClass    AwsDatabaseType @relation(fields: [awsDatabaseTypeId], references: [id])
  dbAllocatedStorage Int
  engine             Engine
  terraformState     Json?
  resourceConfigId   String
  resourceConfig     ResourceConfig  @relation(fields: [resourceConfigId], references: [id], onDelete: Cascade)
}

model AwsStorageInstance {
  id               String         @id @default(uuid())
  bucketName       String
  resourceConfigId String
  terraformState   Json?
  resourceConfig   ResourceConfig @relation(fields: [resourceConfigId], references: [id], onDelete: Cascade)
}

model ownedRepository {
  userId       String
  repositoryId String
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, repositoryId])
}

model RepositoryCollaborator {
  userId       String
  repositoryId String
  assignedAt   DateTime   @default(now())
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, repositoryId])
  @@map("RepositoryCollaborators")
}

model CloudResourceSecret {
  id             String        @id @default(uuid())
  clientId       String        @unique
  clientSecret   String
  subscriptionId String        @unique
  tenantId       String?
  cloudProvider  CloudProvider
  userId         String
  User           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AzureVMSize {
  id                   String            @id @default(uuid())
  name                 String            @unique
  numberOfCores        Int
  maxDataDiskCount     Int
  memoryInMB           Int
  osDiskSizeInMB       Int
  resourceDiskSizeInMB Int
  VMInstance           AzureVMInstance[]
}

model AzurePolicyVM {
  id            String @id @default(uuid())
  name          String
  memoryInMB    Int
  numberOfCores Int
}

model AzurePolicyDatabase {
  id         String @id @default(uuid())
  maxStorage Int
}

model AzurePolicyStorage {
  id         String @id @default(uuid())
  maxStorage Int
}

model AwsPolicyVM {
  id            String @id @default(uuid())
  name          String
  memoryInMB    Int
  numberOfCores Int
}

model AwsPolicyDatabase {
  id         String @id @default(uuid())
  maxStorage Int
}

model AwsPolicyStorage {
  id         String @id @default(uuid())
  maxStorage Int
}

model AwsInstanceType {
  id            String          @id @default(uuid())
  name          String          @unique
  numberOfCores Int
  memoryInMB    Int
  raw           Json
  AwsVMInstance AwsVMInstance[]
}

model AwsDatabaseType {
  id                  String                @id @default(uuid())
  DBInstanceClass     String
  engine              Engine
  raw                 Json
  MinStorageSize      Int
  MaxStorageSize      Int
  AwsDatabaseInstance AwsDatabaseInstance[]

  @@unique([engine, DBInstanceClass])
}

enum RepositoryStatus {
  Created
  Pending
}

enum CloudProvider {
  AWS
  AZURE
}

enum Status {
  Pending
  Approved
  Rejected
}

enum Role {
  Admin
  IT
  Developer
}

enum Engine {
  MySQL
  PostgreSQL
}
